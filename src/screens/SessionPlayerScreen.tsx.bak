import React, { useState, useEffect, useRef, useCallback } from 'react';
import {
  View,
  Text,
  StyleSheet,
  ScrollView,
  TouchableOpacity,
  SafeAreaView,
  Alert,
} from 'react-native';
import { useRoute, useNavigation, RouteProp } from '@react-navigation/native';
import { NativeStackNavigationProp } from '@react-navigation/native-stack';
import { useApp } from '../context/AppContext';
import { getSessionById } from '../data/sessions';
import { colors, typography, spacing, borderRadius, shadows } from '../utils/theme';
import { RootStackParamList, SessionTemplate } from '../types';
import { ttsService, TTSSegment } from '../services/tts';
import { audioService } from '../services/audio';
import { getSessionAudioFile } from '../data/audioAssets';

type RouteProps = RouteProp<RootStackParamList, 'SessionPlayer'>;
type NavigationProp = NativeStackNavigationProp<RootStackParamList>;

type ViewMode = 'script' | 'minimal';

export const SessionPlayerScreen: React.FC = () => {
  const route = useRoute<RouteProps>();
  const navigation = useNavigation<NavigationProp>();
  const { instanceId } = route.params;
  const { todayInstances, startSession, completeSession, appSettings } = useApp();

  const instance = todayInstances.find((i) => i.id === instanceId);
  const session = instance ? getSessionById(instance.templateId) : null;

  const [isPlaying, setIsPlaying] = useState(false);
  const [timeRemaining, setTimeRemaining] = useState(session?.durationSec || 600);
  const [viewMode, setViewMode] = useState<ViewMode>('script');
  const [showDedication, setShowDedication] = useState(false);
  const [ttsEnabled, setTtsEnabled] = useState(false);
  const [currentTTSSegment, setCurrentTTSSegment] = useState<number>(-1);
  const [ttsSegments, setTtsSegments] = useState<TTSSegment[]>([]);

  const timerRef = useRef<ReturnType<typeof setInterval> | null>(null);
  const hasStartedRef = useRef(false);
  const ttsInitializedRef = useRef(false);

  // Parse script to identify pause markers
  const parseScript = useCallback((scriptText: string) => {
    const segments: Array<{
      type: 'text' | 'pause';
      content: string;
      duration?: number;
    }> = [];

    const pauseRegex = /\[pause\s+(\d+)\s*(s|sec|min|m|minutes?)\]/gi;
    let lastIndex = 0;
    let match;

    while ((match = pauseRegex.exec(scriptText)) !== null) {
      // Add text before pause
      if (match.index > lastIndex) {
        segments.push({
          type: 'text',
          content: scriptText.slice(lastIndex, match.index).trim(),
        });
      }

      // Parse pause duration
      const value = parseInt(match[1], 10);
      const unit = match[2].toLowerCase();
      const durationSec =
        unit.startsWith('m') && !unit.startsWith('mi')
          ? value * 60
          : unit.startsWith('min')
          ? value * 60
          : value;

      segments.push({
        type: 'pause',
        content: `Pause for ${
          durationSec >= 60 ? `${Math.floor(durationSec / 60)} minute${durationSec >= 120 ? 's' : ''}` : `${durationSec} seconds`
        }`,
        duration: durationSec,
      });

      lastIndex = match.index + match[0].length;
    }

    // Add remaining text
    if (lastIndex < scriptText.length) {
      segments.push({
        type: 'text',
        content: scriptText.slice(lastIndex).trim(),
      });
    }

    return segments;
  }, []);

  const scriptSegments = session ? parseScript(session.scriptText) : [];

  // Initialize TTS segments with adjusted pauses
  useEffect(() => {
    if (session && !ttsInitializedRef.current) {
      const segments = ttsService.parseScript(session.scriptText);
      const adjustedSegments = ttsService.adjustPausesForDuration(
        segments,
        session.durationSec,
        130 // words per minute - calm meditation pace
      );
      setTtsSegments(adjustedSegments);
      ttsInitializedRef.current = true;
    }
  }, [session]);

  // Initialize TTS enabled state from settings
  useEffect(() => {
    if (appSettings) {
      setTtsEnabled(appSettings.ttsEnabled ?? false);
    }
  }, [appSettings]);

  useEffect(() => {
    if (!hasStartedRef.current && instance) {
      startSession(instanceId);
      hasStartedRef.current = true;
    }
  }, [instanceId, instance, startSession]);

  // Cleanup TTS on unmount
  useEffect(() => {
    return () => {
      ttsService.stop();
    };
  }, []);

  useEffect(() => {
    if (isPlaying && timeRemaining > 0) {
      timerRef.current = setInterval(() => {
        setTimeRemaining((prev) => {
          if (prev <= 1) {
            clearInterval(timerRef.current!);
            setIsPlaying(false);
            setShowDedication(true);
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
    }

    return () => {
      if (timerRef.current) {
        clearInterval(timerRef.current);
      }
    };
  }, [isPlaying, timeRemaining]);

  const formatTime = (seconds: number): string => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  const togglePlay = async () => {
    if (!isPlaying) {
      // Starting playback
      setIsPlaying(true);
      if (ttsEnabled && ttsSegments.length > 0) {
        await ttsService.speakSegments(ttsSegments, {
          rate: appSettings?.ttsSpeakingRate ?? 0.85,
          voice: appSettings?.ttsVoice,
          onSegmentStart: (index) => {
            setCurrentTTSSegment(index);
          },
          onComplete: () => {
            setCurrentTTSSegment(-1);
            setShowDedication(true);
            setIsPlaying(false);
          },
        });
      }
    } else {
      // Pausing playback
      setIsPlaying(false);
      if (ttsEnabled) {
        ttsService.pause();
      }
    }
  };

  const toggleTTS = () => {
    const newTtsEnabled = !ttsEnabled;
    setTtsEnabled(newTtsEnabled);
    if (!newTtsEnabled && ttsService.getIsPlaying()) {
      ttsService.stop();
      setCurrentTTSSegment(-1);
    }
  };

  const handleComplete = async () => {
    await completeSession(instanceId);
    navigation.goBack();
  };

  const handleEndEarly = async () => {
    await ttsService.stop();
    setIsPlaying(false);
    navigation.goBack();
  };

  if (!session || !instance) {
    return (
      <SafeAreaView style={styles.container}>
        <View style={styles.errorContainer}>
          <Text style={styles.errorText}>Session not found</Text>
          <TouchableOpacity
            style={styles.backButton}
            onPress={() => navigation.goBack()}
          >
            <Text style={styles.backButtonText}>Return</Text>
          </TouchableOpacity>
        </View>
      </SafeAreaView>
    );
  }

  if (showDedication) {
    return (
      <SafeAreaView style={styles.container}>
        <View style={styles.dedicationContainer}>
          <Text style={styles.dedicationTitle}>Session Complete</Text>
          {session.dedication && (
            <Text style={styles.dedicationText}>{session.dedication}</Text>
          )}
          <TouchableOpacity style={styles.completeButton} onPress={handleComplete}>
            <Text style={styles.completeButtonText}>Return</Text>
          </TouchableOpacity>
        </View>
      </SafeAreaView>
    );
  }

  // When meditation is playing, show a simple pleasant timer view
  if (isPlaying) {
    return (
      <SafeAreaView style={styles.container}>
        <View style={styles.meditationView}>
          <TouchableOpacity
            style={styles.endButtonFloating}
            onPress={handleEndEarly}
          >
            <Text style={styles.endButtonText}>End</Text>
          </TouchableOpacity>

          <View style={styles.meditationContent}>
            <Text style={styles.meditationTitle}>{session.title}</Text>
            <Text style={styles.meditationTimer}>{formatTime(timeRemaining)}</Text>
            <Text style={styles.meditationPrompt}>{session.shortPrompt}</Text>
          </View>

          <View style={styles.meditationControls}>
            <TouchableOpacity
              style={[styles.ttsToggle, ttsEnabled && styles.ttsToggleActive]}
              onPress={toggleTTS}
            >
              <Text style={[styles.ttsToggleText, ttsEnabled && styles.ttsToggleTextActive]}>
                Voice {ttsEnabled ? 'On' : 'Off'}
              </Text>
            </TouchableOpacity>
            <TouchableOpacity style={styles.pauseButton} onPress={togglePlay}>
              <Text style={styles.pauseButtonText}>Pause</Text>
            </TouchableOpacity>
          </View>
        </View>
      </SafeAreaView>
    );
  }

  return (
    <SafeAreaView style={styles.container}>
      <View style={styles.header}>
        <TouchableOpacity
          style={styles.closeButton}
          onPress={handleEndEarly}
        >
          <Text style={styles.closeButtonText}>End</Text>
        </TouchableOpacity>
        <View style={styles.headerCenter}>
          <Text style={styles.sessionTitle}>{session.title}</Text>
          <Text style={styles.timer}>{formatTime(timeRemaining)}</Text>
        </View>
        <View style={styles.headerRight} />
      </View>

      <View style={styles.viewToggle}>
        <TouchableOpacity
          style={[
            styles.toggleButton,
            ttsEnabled && styles.toggleButtonActive,
          ]}
          onPress={toggleTTS}
        >
          <Text
            style={[
              styles.toggleText,
              ttsEnabled && styles.toggleTextActive,
            ]}
          >
            Voice {ttsEnabled ? 'On' : 'Off'}
          </Text>
        </TouchableOpacity>
      </View>

      <ScrollView
        style={styles.scrollView}
        contentContainerStyle={styles.scriptContent}
      >
        <View style={styles.preSessionView}>
          <Text style={styles.preSessionPrompt}>{session.shortPrompt}</Text>
          <Text style={styles.preSessionInstruction}>
            Find a comfortable position and prepare to begin.
          </Text>
        </View>
      </ScrollView>

      <View style={styles.controls}>
        <TouchableOpacity style={styles.playButton} onPress={togglePlay}>
          <Text style={styles.playButtonText}>Begin Meditation</Text>
        </TouchableOpacity>
      </View>
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: colors.background,
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingHorizontal: spacing.md,
    paddingVertical: spacing.md,
    borderBottomWidth: 1,
    borderBottomColor: colors.border,
  },
  closeButton: {
    paddingVertical: spacing.xs,
    paddingHorizontal: spacing.sm,
  },
  closeButtonText: {
    color: colors.textSecondary,
    fontSize: typography.fontSizes.md,
  },
  headerCenter: {
    alignItems: 'center',
  },
  headerRight: {
    width: 50,
  },
  sessionTitle: {
    color: colors.textPrimary,
    fontSize: typography.fontSizes.lg,
    fontWeight: typography.fontWeights.semibold,
  },
  timer: {
    color: colors.accent,
    fontSize: typography.fontSizes.xxl,
    fontWeight: typography.fontWeights.bold,
    marginTop: spacing.xs,
  },
  viewToggle: {
    flexDirection: 'row',
    padding: spacing.md,
    gap: spacing.sm,
  },
  toggleButton: {
    flex: 1,
    paddingVertical: spacing.sm,
    alignItems: 'center',
    borderRadius: borderRadius.md,
    backgroundColor: colors.surface,
  },
  toggleButtonActive: {
    backgroundColor: colors.primary,
  },
  toggleText: {
    color: colors.textSecondary,
    fontSize: typography.fontSizes.sm,
    fontWeight: typography.fontWeights.medium,
  },
  toggleTextActive: {
    color: colors.white,
  },
  scrollView: {
    flex: 1,
  },
  scriptContent: {
    padding: spacing.lg,
    paddingBottom: spacing.xxl,
  },
  segment: {
    marginBottom: spacing.lg,
  },
  activeSegment: {
    backgroundColor: colors.surface,
    padding: spacing.md,
    borderRadius: borderRadius.md,
    marginHorizontal: -spacing.md,
  },
  scriptText: {
    color: colors.textPrimary,
    fontSize: typography.fontSizes.lg,
    lineHeight: typography.fontSizes.lg * typography.lineHeights.relaxed,
  },
  activeScriptText: {
    color: colors.accent,
  },
  pauseMarker: {
    backgroundColor: colors.surface,
    paddingVertical: spacing.md,
    paddingHorizontal: spacing.lg,
    borderRadius: borderRadius.md,
    alignItems: 'center',
    borderLeftWidth: 3,
    borderLeftColor: colors.accent,
  },
  activePauseMarker: {
    backgroundColor: colors.primary,
    borderLeftColor: colors.white,
  },
  pauseText: {
    color: colors.accent,
    fontSize: typography.fontSizes.md,
    fontStyle: 'italic',
  },
  minimalView: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    paddingVertical: spacing.xxl,
  },
  minimalPrompt: {
    color: colors.textPrimary,
    fontSize: typography.fontSizes.xxl,
    fontStyle: 'italic',
    textAlign: 'center',
    marginBottom: spacing.lg,
    lineHeight: typography.fontSizes.xxl * typography.lineHeights.relaxed,
  },
  minimalInstruction: {
    color: colors.textMuted,
    fontSize: typography.fontSizes.md,
    textAlign: 'center',
  },
  controls: {
    padding: spacing.lg,
    paddingBottom: spacing.xl,
    borderTopWidth: 1,
    borderTopColor: colors.border,
  },
  playButton: {
    backgroundColor: colors.primary,
    paddingVertical: spacing.md,
    borderRadius: borderRadius.lg,
    alignItems: 'center',
    ...shadows.md,
  },
  playButtonText: {
    color: colors.white,
    fontSize: typography.fontSizes.lg,
    fontWeight: typography.fontWeights.semibold,
  },
  errorContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: spacing.lg,
  },
  errorText: {
    color: colors.textSecondary,
    fontSize: typography.fontSizes.lg,
    marginBottom: spacing.lg,
  },
  backButton: {
    paddingVertical: spacing.sm,
    paddingHorizontal: spacing.lg,
    backgroundColor: colors.primary,
    borderRadius: borderRadius.md,
  },
  backButtonText: {
    color: colors.white,
    fontSize: typography.fontSizes.md,
  },
  dedicationContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: spacing.xl,
  },
  dedicationTitle: {
    color: colors.textPrimary,
    fontSize: typography.fontSizes.xxl,
    fontWeight: typography.fontWeights.semibold,
    marginBottom: spacing.xl,
  },
  dedicationText: {
    color: colors.accent,
    fontSize: typography.fontSizes.lg,
    fontStyle: 'italic',
    textAlign: 'center',
    lineHeight: typography.fontSizes.lg * typography.lineHeights.relaxed,
    marginBottom: spacing.xl,
  },
  completeButton: {
    backgroundColor: colors.primary,
    paddingVertical: spacing.md,
    paddingHorizontal: spacing.xxl,
    borderRadius: borderRadius.lg,
    ...shadows.md,
  },
  completeButtonText: {
    color: colors.white,
    fontSize: typography.fontSizes.lg,
    fontWeight: typography.fontWeights.semibold,
  },
  // Meditation playing view styles
  meditationView: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: spacing.xl,
  },
  endButtonFloating: {
    position: 'absolute',
    top: spacing.lg,
    left: spacing.lg,
    paddingVertical: spacing.sm,
    paddingHorizontal: spacing.md,
  },
  endButtonText: {
    color: colors.textMuted,
    fontSize: typography.fontSizes.md,
  },
  meditationContent: {
    alignItems: 'center',
    marginBottom: spacing.xxl,
  },
  meditationTitle: {
    color: colors.textSecondary,
    fontSize: typography.fontSizes.lg,
    marginBottom: spacing.md,
  },
  meditationTimer: {
    color: colors.accent,
    fontSize: 72,
    fontWeight: typography.fontWeights.light,
    marginBottom: spacing.xl,
    letterSpacing: 4,
  },
  meditationPrompt: {
    color: colors.textMuted,
    fontSize: typography.fontSizes.md,
    fontStyle: 'italic',
    textAlign: 'center',
    maxWidth: 300,
  },
  meditationControls: {
    flexDirection: 'row',
    gap: spacing.md,
  },
  ttsToggle: {
    paddingVertical: spacing.sm,
    paddingHorizontal: spacing.lg,
    borderRadius: borderRadius.lg,
    backgroundColor: colors.surface,
  },
  ttsToggleActive: {
    backgroundColor: colors.primary,
  },
  ttsToggleText: {
    color: colors.textSecondary,
    fontSize: typography.fontSizes.sm,
  },
  ttsToggleTextActive: {
    color: colors.white,
  },
  pauseButton: {
    paddingVertical: spacing.sm,
    paddingHorizontal: spacing.lg,
    borderRadius: borderRadius.lg,
    backgroundColor: colors.surface,
  },
  pauseButtonText: {
    color: colors.textSecondary,
    fontSize: typography.fontSizes.sm,
  },
  // Pre-session view styles
  preSessionView: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    paddingVertical: spacing.xxl * 2,
  },
  preSessionPrompt: {
    color: colors.textPrimary,
    fontSize: typography.fontSizes.xxl,
    fontStyle: 'italic',
    textAlign: 'center',
    marginBottom: spacing.lg,
    lineHeight: typography.fontSizes.xxl * typography.lineHeights.relaxed,
  },
  preSessionInstruction: {
    color: colors.textMuted,
    fontSize: typography.fontSizes.md,
    textAlign: 'center',
  },
});
